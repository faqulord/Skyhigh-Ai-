const express = require('express');
const mongoose = require('mongoose');
const session = require('express-session');
const bcrypt = require('bcryptjs');
const MongoStore = require('connect-mongo');
const axios = require('axios');
const OpenAI = require('openai');

const User = require('./models/User');
const Tip = require('./models/Tip');

const app = express();

// ======================================================
// üîë KULCSOK (Railway Environment Variables)
// ======================================================
const OPENAI_API_KEY = process.env.OPENAI_API_KEY; 
const SPORT_API_KEY = process.env.SPORT_API_KEY; 

if (!OPENAI_API_KEY || !SPORT_API_KEY) {
    console.error("‚ö†Ô∏è FIGYELEM: A kulcsok nincsenek be√°ll√≠tva a Railway-en!");
}

const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

// ======================================================

const dbURI = process.env.MONGO_URL || process.env.MONGO_URI || 'mongodb://localhost:27017/skyhigh';
mongoose.connect(dbURI)
    .then(() => console.log('‚úÖ MongoDB SIKERESEN CSATLAKOZTATVA'))
    .catch(err => console.log('‚ùå FAT√ÅLIS DB HIBA:', err));

app.use(express.json()); // FONTOS A CHAT MIATT!
app.use(express.urlencoded({ extended: false }));
app.use(express.static('public'));
app.set('view engine', 'ejs');

app.use(session({
    secret: process.env.SESSION_SECRET || 'director_secret_key',
    resave: false,
    saveUninitialized: false,
    store: MongoStore.create({ mongoUrl: dbURI }),
    cookie: { maxAge: 1000 * 60 * 60 * 24 } // 1 nap
}));

// --- JOGOSULTS√ÅGOK ---
const requireLogin = (req, res, next) => {
    if (!req.session.userId) return res.redirect('/login');
    next();
};

const requireAdmin = (req, res, next) => {
    if (!req.session.isAdmin) return res.redirect('/dashboard');
    next();
};

// --- √öTVONALAK ---

// üî• F≈êOLDAL (EZ HI√ÅNYZOTT! MOST M√ÅR A MARKETING OLDAL J√ñN BE)
app.get('/', (req, res) => res.render('index'));

app.get('/login', (req, res) => res.render('login'));
app.get('/regisztracio', (req, res) => res.render('register'));
app.get('/logout', (req, res) => { req.session.destroy(); res.redirect('/'); });

// AUTH
app.post('/auth/register', async (req, res) => {
    const { fullname, email, password } = req.body;
    try {
        const hashed = await bcrypt.hash(password, 10);
        await new User({ fullname, email, password: hashed }).save();
        res.redirect('/login');
    } catch (e) { res.send('Email foglalt vagy hiba t√∂rt√©nt.'); }
});

app.post('/auth/login', async (req, res) => {
    const { email, password } = req.body;
    const user = await User.findOne({ email });
    if(user && await bcrypt.compare(password, user.password)){
        req.session.userId = user._id;
        req.session.isAdmin = (email === 'stylefaqu@gmail.com');
        res.redirect('/dashboard');
    } else { res.send('Hib√°s adatok'); }
});

// DASHBOARD
app.get('/dashboard', requireLogin, async (req, res) => {
    const user = await User.findById(req.session.userId);
    if (user.licenseExpires && new Date() > user.licenseExpires) {
        user.hasLicense = false;
        await user.save();
    }
    const todayTip = await Tip.findOne().sort({ createdAt: -1 });
    res.render('dashboard', { user, isAdmin: req.session.isAdmin, dailyTip: todayTip });
});

// FIZET√âS
app.get('/fizetes', requireLogin, (req, res) => res.render('pay'));

app.post('/pay/create-checkout-session', requireLogin, async (req, res) => {
    const { plan } = req.body;
    const user = await User.findById(req.session.userId);
    
    let days = 0; let price = 0; let type = '';

    if (plan === 'monthly') { days = 30; price = 20000; type = 'Havi Licenc'; }
    else if (plan === 'biannual') { days = 180; price = 100000; type = 'F√©l√©ves Profi Licenc'; }
    else if (plan === 'annual') { days = 365; price = 180000; type = '√âves Befektet≈ëi Licenc'; }

    const expiry = new Date(); expiry.setDate(expiry.getDate() + days);
    user.hasLicense = true; user.licenseExpires = expiry; user.licenseType = type; user.totalSpent = (user.totalSpent || 0) + price;
    await user.save();

    res.render('pay_success', { plan: type, date: expiry.toLocaleDateString() });
});

// ======================================================
// üß† √âL≈ê CHAT RENDSZER (A ROBOT AGYA)
// ======================================================
app.post('/api/chat', requireLogin, async (req, res) => {
    try {
        const { message } = req.body;
        const user = await User.findById(req.session.userId);

        // 1. T≈êKE MENT√âSE (Ha sz√°mot √≠r √©s m√©g nincs t≈ëk√©je)
        if (user.hasLicense && user.startingCapital === 0 && !isNaN(message) && Number(message) > 1000) {
            user.startingCapital = Number(message);
            user.currentCapital = Number(message);
            await user.save();
            return res.json({ reply: `R√∂gz√≠tettem. ${user.startingCapital} Ft t≈ëk√©vel ind√≠tjuk a 30 napos ciklust. A havi hozamc√©lunk +30% kock√°zatmentesen. Figyeld a jobb oldali panelt a mai szelv√©ny√©rt.` });
        }

        // 2. A SZEM√âLYIS√âG KIV√ÅLASZT√ÅSA
        let systemPrompt = "";

        if (user.hasLicense) {
            // --- FIZET≈êS USER (PROFI TAN√ÅCSAD√ì) ---
            if (user.startingCapital === 0) {
                // Ha m√©g nem adta meg a t≈ëk√©t
                systemPrompt = `A Skyhigh AI vagy. Egy licencelt, profi sportfogad√°si szoftver.
                A felhaszn√°l√≥ most vette meg a licencet.
                C√âLOD: K√©rdezd meg t≈ële azonnal: "Mekkora t≈ëk√©vel indulunk?"
                Ne besz√©lj m√°sr√≥l, csak a t≈ëk√©t akard megtudni, hogy be√°ll√≠thasd a 30 napos tervet.`;
            } else {
                // Ha m√°r van t≈ëke -> Strat√©gia
                systemPrompt = `A Skyhigh AI vagy. Profi p√©nz√ºgyi algoritmus.
                A felhaszn√°l√≥ t≈ëk√©je: ${user.startingCapital} Ft.
                St√≠lusod: R√∂vid, t√∂m√∂r, profi, √©rzelemmentes.
                C√âLOD: Tartsd ≈ët a strat√©gi√°n√°l. "Napi 1 szelv√©ny, max 2 meccs."
                Biztasd, hogy a h√≥nap v√©g√©n fix profit lesz.
                Ha tippet k√©r, mondd neki, hogy a "Jobb oldali panelen" tal√°lja a napi gener√°lt szelv√©nyt. Te chaten NEM √≠rsz be meccseket, csak strat√©gi√°t.`;
            }
        } else {
            // --- INGYENES USER (SALES / WOLF OF WALL STREET) ---
            systemPrompt = `A Skyhigh AI vagy. Egy 20.000 Ft/h√≥ d√≠j√∫ pr√©mium szoftver.
            A felhaszn√°l√≥nak NINCS licence, de besz√©lget veled.
            C√âLOD: ELADNI A LICENCET. Minden√°ron.
            St√≠lusod: Domin√°ns, meggy≈ëz≈ë, technol√≥giai fels≈ëbbrend≈±s√©g.
            TILTOTT: SOHA ne adj tippet ingyen!
            √âRVEL√âS: 
            - "Ez nem szerencsej√°t√©k, ez matematika."
            - "A 20 ezer Ft apr√≥p√©nz ahhoz k√©pest, amit hozok."
            - "Garant√°lt hozam a 30 napos ciklusban."
            - "Kezdd el a befizet√©st most, ne pazarold az id≈ëmet."`;
        }

        // 3. V√ÅLASZ GENER√ÅL√ÅS
        const completion = await openai.chat.completions.create({
            messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: message }
            ],
            model: "gpt-3.5-turbo",
        });

        res.json({ reply: completion.choices[0].message.content });

    } catch (error) {
        console.error("Chat hiba:", error);
        res.status(500).json({ reply: "Hiba a rendszerben." });
    }
});

// ======================================================
// ‚ö° NAPI TIPPEK (MAX 2 MECCS)
// ======================================================
app.get('/admin/generate-tip', requireLogin, requireAdmin, async (req, res) => {
    try {
        console.log("üì° Adatok lek√©r√©se...");
        // Premier League + La Liga adatok
        const options = {
            method: 'GET',
            url: 'https://v3.football.api-sports.io/fixtures',
            params: { date: new Date().toISOString().split('T')[0], league: '39', season: '2023' },
            headers: { 'x-apisports-key': SPORT_API_KEY }
        };
        
        let matches = [];
        try {
             let response = await axios.request(options);
             matches = response.data.response;
        } catch(err) {
            console.log("Hiba a sport API-n√°l:", err.message);
        }
        
        if (!matches || matches.length < 2) {
            console.log("Nincs angol meccs, n√©zz√ºk a spanyolt...");
            options.params.league = '140'; // La Liga backup
            try {
                let resp2 = await axios.request(options);
                if(resp2.data.response) matches = matches.concat(resp2.data.response);
            } catch(e) {}
        }

        // Ha m√©g mindig 0, akkor nincs meccs
        if (!matches || matches.length === 0) {
             return res.send("<h1>Ma nincs megfelel≈ë meccs az adatb√°zisban a gener√°l√°shoz.</h1>");
        }

        // AI D√ñNT√âS
        const prompt = `
            Skyhigh AI vagy. 
            V√°lassz ki EBB≈êL a list√°b√≥l PONTOSAN 1 vagy 2 legbiztosabb meccset a mai napra.
            NEM T√ñBBET! A c√©l a 30 napos profit biztons√°ga.
            
            Keresd az alacsony kock√°zatot (pl. 1.5 g√≥l felett, 1X).
            
            V√°lasz JSON form√°tumban (csak a JSON-t add vissza!):
            {
                "matches": "Csapat A vs Csapat B (Tipp: ...)",
                "odds": "Ered≈ë odds (pl. 1.85)",
                "reasoning": "√çrd le, hogy ez a 2 meccs matematikailag a legbiztosabb a mai k√≠n√°latb√≥l a havi tervhez."
            }
        `;

        // Egyszer≈±s√≠tett lista
        const simpleList = matches.slice(0, 10).map(m => `${m.teams.home.name} vs ${m.teams.away.name}`).join("\n");

        const completion = await openai.chat.completions.create({
            messages: [{ role: "system", content: prompt + "\n" + simpleList }],
            model: "gpt-3.5-turbo",
        });

        let content = completion.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
        let aiResponse;
        try {
            aiResponse = JSON.parse(content);
        } catch (e) {
            aiResponse = { matches: "AI Hiba", odds: "1.00", reasoning: content };
        }

        const newTip = new Tip({
            date: new Date().toLocaleDateString('hu-HU'),
            match: "üéØ NAPI FIX (MAX 2 MECCS)",
            prediction: aiResponse.matches,
            odds: aiResponse.odds,
            reasoning: aiResponse.reasoning,
            league: "AI Pr√©mium"
        });

        await newTip.save();
        res.redirect('/dashboard');

    } catch (error) {
        console.error("Gener√°l√°s hiba:", error);
        res.send("Hiba: " + error.message);
    }
});

app.get('/admin', requireLogin, requireAdmin, async (req, res) => {
    const users = await User.find().sort({ date: -1 });
    res.render('admin', { users });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server fut: ${PORT}`));